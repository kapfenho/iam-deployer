# Â´Oracle Identity and Access Management
#
VAGRANTFILE_API_VERSION = "2"
app_name       = "iam2.dev.vm"
app_name_short = "iam2"
app_ip         = "192.168.168.40"
app_box        = "centos6min"
app_box_url    = "https://agoracon.at/boxes/centos6min.box"
mnt           = "/mnt/orainst"
# md5     51ff639a683250df87cb4fd802363121  centos6min.box
# sha512  8b4e32ed18e88ff47d69a1523203a92cdc5b2152014e43956e21c963801219fe
#         1e8898ece714f4695c9f3982f627e1071b557392cba0b167d709cccb951754ce
$hostfile = "# hostfile generated by vagrant provisioning
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
#{db_ip} #{db_name} #{db_name_short}"
 
$script_mnt   = "( [ -a ${mnt} ] || mkdir -m 0777 #{mnt} ) && if ! mount | grep -q 'orainst' ; then mount -f -t nfs nyx:/instora #{mnt} ; fi"
$script_sys   = "/vagrant/sys.sh && ~/root-script.sh"
$script_dbs   = "su - oracle -c '/vagrant/db.sh | /usr/bin/tee /tmp/prov-dbs.log'"

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  config.vm.define :db, primary: true do |db|
    app.vm.box      = app_box
    app.vm.hostname = app_name
    app.vm.box_url  = app_box_url

    app.vm.network :private_network, ip: app_ip

    #app.vm.synced_folder "/mnt/instora", "/mnt/orainst", nfs: true

    app.vm.provider :virtualbox do |vb|
      vb.customize ["modifyvm", :id,
                    "--memory", "6144",
                    "--name", app_name,
                    "--cpus", "4"]
    end
    app.vm.provision :shell, inline: "echo provisioning /etc/hosts"
    app.vm.provision :shell, inline: "echo '#{$hostfile}' > /etc/hosts" 
    app.vm.provision :shell, inline: $script_mnt
    app.vm.provision :shell, inline: $script_sys
    app.vm.provision :shell, inline: $script_dbs

  end

end
#
# Toloplogies
# -----------
#  * single host
#  * database, appserver
#  * database, appserver, reverse proxy (VLAN/LAN: data, trusted, dmz)
#  * TODO: clustering within area
#
# vi: set ft=ruby :
