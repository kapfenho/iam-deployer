# Â´Oracle Identity and Access Management
#
VAGRANTFILE_API_VERSION = "2"
app_name       = "iam2.agoracon.at"
app_name_short = "iam2"
app_ip         = "192.168.168.41"
app_box        = "centos6min"
app_box_url    = "https://agoracon.at/boxes/centos6min.box"
app_box_sha    = "bce6a99728ceaeb017f475ee734f676390cf8c49b6aed721a3247c204daa507f"
mnt            = "/mnt/oracle"

$hostfile = "# hostfile generated by vagrant provisioning
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
#{app_ip} #{app_name} #{app_name_short}"
 
$script_mnt = "( [ -a #{mnt} ] || mkdir -m 0777 #{mnt} ) && if ! mount | grep -q 'orainst' ; then mount -t nfs nyx:/instora #{mnt} ; fi"
$script_sys = "/vagrant/sys.sh && ~/root-script.sh"
$script_dbs = "su - oracle -c '/vagrant/db.sh | /usr/bin/tee /tmp/prov-dbs.log'"

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  config.vm.define :app, primary: true do |app|
    app.vm.box                        = app_box
    app.vm.hostname                   = app_name
    app.vm.box_url                    = app_box_url
    app.vm.box_download_checksum      = app_box_sha
    app.vm.box_download_checksum_type = "sha256"

    app.vm.network :private_network, ip: app_ip

    # install images on local machine (host)
    #app.vm.synced_folder "/mnt/instora", "/mnt/orainst", nfs: true

    app.vm.provider :virtualbox do |vb|
      vb.customize ["modifyvm", :id,
                    "--memory", "12288",
                    "--name", app_name,
                    "--cpus", "4"]
    end
    app.vm.provision :shell, inline: "echo provisioning /etc/hosts"
    app.vm.provision :shell, inline: "echo '#{$hostfile}' > /etc/hosts" 
    app.vm.provision :shell, inline: $script_mnt
    app.vm.provision :shell, inline: $script_sys
    app.vm.provision :shell, inline: $script_dbs

  end

end
#
# Toloplogies
# -----------
#  * single host
#  * database, appserver
#  * database, appserver, reverse proxy (VLAN/LAN: data, trusted, dmz)
#  * TODO: clustering within area
#
# checksums of centos6min machine
# -------------------------------
# md5     99c174a27c76fbe3ca9f5d7f67ea41be                  centos6min.box
# sha256  acd3484b4733ac0df7e74c86e235025e5ba19d0cc7979b5f3e8c7a85e451b72f
# vi: set ft=ruby :
